AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Tenant Portal related APIs.

Parameters:
  DataStack:
    Type: String
    Description: Data Stack
  Environment:
    Type: String
    Description: The runtime environment of this stack
  CloudFrontPublicKeyIdParam:
    Type: String
    Description: CloudFront Public Key ID from cloudfront-key stack
    Default: ""
  CloudFrontPrivateKeySecretArn:
    Type: String
    Description: ARN of the Secrets Manager secret containing the CloudFront private key
    Default: ""
  MapBurstLimit:
    Type: Number
    Default: 100
  MapRateLimit:
    Type: Number
    Default: 100
  MapThrottlingLimit:
    Type: Number
    Default: 100
  MapThrottlingBurstLimit:
    Type: Number
    Default: 100

Conditions:
  # If the build is not on Deployment branch this condition is true.
  IsTestBuild: !Not
    - !Or
      - !Equals [!Ref Environment, "dev"]
      - !Equals [!Ref Environment, "uat"]
      - !Equals [!Ref Environment, "prod"]
  # Check if CloudFront keys are provided
  UseProvidedCloudFrontKeys: !Not [!Equals [!Ref CloudFrontPublicKeyIdParam, ""]]

Mappings:
  # ============================================================================
  # Account-specific configurations for domain names and Cognito settings
  # ============================================================================
  # 
  # Before deployment, configure the following for each AWS account/environment:
  # 
  # 1. Route 53 Setup (Required):
  #    - Create or import domain in Route 53
  #    - Get Hosted Zone ID: aws route53 list-hosted-zones
  #    - Update nameservers at domain registrar if using external domain
  #    - Wait for DNS propagation (24-48 hours)
  # 
  # 2. Update this mapping with:
  #    - Your AWS Account ID (get via: aws sts get-caller-identity)
  #    - APSouthDomainName: Your domain/subdomain for API Gateway
  #    - APSouthHostedZoneId: Your Route 53 Hosted Zone ID (without /hostedzone/ prefix)
  #    - TenantClientTokenValidityHRS: Cognito access token validity (hours)
  #    - TenantClientAuthSessionValidityMin: Cognito auth session validity (minutes)
  # 
  # Example domain setup:
  #   - dev environment:  dev.your-domain.com
  #   - uat environment:  uat.your-domain.com
  #   - prod environment: www.your-domain.com or your-domain.com
  # 
  # See docs/101/DEPLOYMENT_GUIDE.md for complete setup instructions
  # ============================================================================
  
  AccountMappings:
    "622778846370": # dev account
      APSouthDomainName: mvp-dev.4cl-tech.com.au
      APSouthHostedZoneId: Z07064771YL69HXR2PLAL
      TenantClientTokenValidityHRS: 10
      TenantClientAuthSessionValidityMin: 5
    
    # Add additional AWS accounts/environments below:
    # 
    # "YOUR_UAT_ACCOUNT_ID": # uat account
    #   APSouthDomainName: uat.your-domain.com
    #   APSouthHostedZoneId: Z08123456EXAMPLE
    #   TenantClientTokenValidityHRS: 12
    #   TenantClientAuthSessionValidityMin: 10
    # 
    # "YOUR_PROD_ACCOUNT_ID": # prod account
    #   APSouthDomainName: www.your-domain.com
    #   APSouthHostedZoneId: Z09123456EXAMPLE
    #   TenantClientTokenValidityHRS: 24
    #   TenantClientAuthSessionValidityMin: 15

Resources:
  #  ---------- 1. General SSM Parameters ------------------------------------------------------
  #  ------------------------------------------------------------------------------------------
  #  ------------------------------------------------------------------------------------------

  # Public Key ID - use parameter if provided, otherwise use default
  CloudFrontPublicKeyId:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/cloudfront/public-key-id
      Type: String
      Value: !If
        - UseProvidedCloudFrontKeys
        - !Ref CloudFrontPublicKeyIdParam
        - KJSZ8RHPSJO2B

  # ---------- 3. API gateway ----------------------------------------------------------------
  # ------------------------------------------------------------------------------------------
  # ------------------------------------------------------------------------------------------
  TenantAPIGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      OpenApiVersion: "3.0"
      Domain:
        CertificateArn: !Ref TenantDomainACM
        DomainName: !If
          - IsTestBuild
          - !Sub
            - ${Environment}.${DomainName}
            - DomainName:
                !FindInMap [
                  AccountMappings,
                  !Ref "AWS::AccountId",
                  APSouthDomainName,
                ]
          - !FindInMap [
              AccountMappings,
              !Ref "AWS::AccountId",
              APSouthDomainName,
            ]
        Route53:
          HostedZoneId:
            !FindInMap [
              AccountMappings,
              !Ref "AWS::AccountId",
              APSouthHostedZoneId,
            ]
        EndpointConfiguration: REGIONAL
      Cors:
        AllowMethods: "'POST, GET, PATCH, PUT, DELETE'"
        AllowHeaders: "'*'"
        AllowOrigin: "'*'"
        MaxAge: "'600'"
      EndpointConfiguration:
        Type: REGIONAL
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: "../../swagger-docs/tenant/tenant-apis.yaml"
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          DataTraceEnabled: true
          LoggingLevel: INFO
          MetricsEnabled: true
          ThrottlingRateLimit: !Ref MapThrottlingLimit
          ThrottlingBurstLimit: !Ref MapThrottlingBurstLimit
      TracingEnabled: true

  TenantAPIGatewayUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    # Adding TenantAPIGatewayStage in order to create UsagePlan after stage is created
    # referring to TenantAPIGatewayStage (<api-name>Stage) which is the default name creation for stage in AWS
    DependsOn:
      - TenantAPIGatewayStage
    Properties:
      ApiStages:
        - ApiId: !Ref TenantAPIGateway
          Stage: !Ref Environment
      Description: Usage plan for this API
      # Update throttle settings based on env
      Throttle:
        RateLimit: !Ref MapBurstLimit
        BurstLimit: !Ref MapRateLimit

  TenantAPIGatewayUsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    DependsOn:
      - TenantAPIGatewayStage
    Properties:
      KeyId: !Ref TenantAPIGatewayApiKey
      KeyType: API_KEY
      UsagePlanId: !Ref TenantAPIGatewayUsagePlan

  TenantAPIGatewayApiKey:
    Type: AWS::ApiGateway::ApiKey
    DependsOn:
      - TenantAPIGatewayUsagePlan
      - TenantAPIGatewayStage
    Properties:
      Enabled: true
      StageKeys:
        - RestApiId: !Ref TenantAPIGateway
          StageName: !Ref Environment
      Value:
        !Join [
          "",
          [
            "{{resolve:secretsmanager:",
            !Ref GenerateSecretKey,
            ":SecretString:apikey}}",
          ],
        ]

  GenerateSecretKey:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub SecretKeyTenantAPI/${Environment}
      GenerateSecretString:
        SecretStringTemplate: '{"username": "getapikey"}'
        ExcludePunctuation: true
        GenerateStringKey: "apikey"
        PasswordLength: 21

  TenantDomainACM:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !If
        - IsTestBuild
        - !Sub
          - ${Environment}.${DomainName}
          - DomainName:
              !FindInMap [
                AccountMappings,
                !Ref "AWS::AccountId",
                APSouthDomainName,
              ]
        - !FindInMap [AccountMappings, !Ref "AWS::AccountId", APSouthDomainName]
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !If
            - IsTestBuild
            - !Sub
              - ${Environment}.${DomainName}
              - DomainName:
                  !FindInMap [
                    AccountMappings,
                    !Ref "AWS::AccountId",
                    APSouthDomainName,
                  ]
            - !FindInMap [
                AccountMappings,
                !Ref "AWS::AccountId",
                APSouthDomainName,
              ]
          HostedZoneId:
            !FindInMap [
              AccountMappings,
              !Ref "AWS::AccountId",
              APSouthHostedZoneId,
            ]

  # -----------4. All DDB Tables in Tenant Portal--------------------------------------------------------------------------------------------------
  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # ------------------------------------------------------------------------------------------------------------------------------------------------

  # ----------A)Tenant Users Portal Related DDB Tables -----
  # ------------------------------------------------------------------------------------------------------------------------------------------------

  # --Employee Data DDB Tables and related Indexes---

  DDBEmployeeDataTableEmailIdIndex:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/dynamodb/EmployeeDataTable-EmailIdIndex
      Type: String
      Value: EmailId_Index
  DDBEmployeeDataTableExternalIdIndex:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/dynamodb/EmployeeDataTable-ExternalIdIndex
      Type: String
      Value: ExternalId_Index
  DDBEmployeeDataTableCognitoIdIndex:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/dynamodb/EmployeeDataTable-CognitoIdIndex
      Type: String
      Value: CognitoId_Index

  EmployeeDataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub EmployeeDataTable-${Environment}
      AttributeDefinitions:
        - AttributeName: "UserName"
          AttributeType: "S"
        - AttributeName: "EmailId"
          AttributeType: "S"
        - AttributeName: "ExternalId"
          AttributeType: "S"
        - AttributeName: "CognitoId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "UserName"
          KeyType: "HASH"
      BillingMode: "PAY_PER_REQUEST"
      GlobalSecondaryIndexes:
        - IndexName: !GetAtt DDBEmployeeDataTableEmailIdIndex.Value
          KeySchema:
            - AttributeName: "EmailId"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
        - IndexName: !GetAtt DDBEmployeeDataTableExternalIdIndex.Value
          KeySchema:
            - AttributeName: "ExternalId"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
        - IndexName: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value
          KeySchema:
            - AttributeName: "CognitoId"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"


  # Tenant Engagement table and related Indexes
  DDBTenantEngagementTableProvidedByIndex:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/dynamodb/EngagementId-ProvidedByIndex
      Type: String
      Value: EngagementId_ProvidedBy_Index
  DDBTenantEngagementTableEngagementIdIndex:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/dynamodb/EntityId-EngagementIdIndex
      Type: String
      Value: EntityId_EngagementId_Index

  DDBTenantEngagementTableTimeStampIndex:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/dynamodb/EntityId-TimestampIndex
      Type: String
      Value: EntityId_Timestamp_Index

  TenantEngagementTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub TenantEngagementTable-${Environment}
      AttributeDefinitions:
        - AttributeName: EngagementId
          AttributeType: S
        - AttributeName: EntityId
          AttributeType: S
        - AttributeName: ProvidedBy
          AttributeType: S
        - AttributeName: Timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: EngagementId
          KeyType: HASH
        - AttributeName: EntityId
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: !GetAtt DDBTenantEngagementTableProvidedByIndex.Value
          KeySchema:
            - AttributeName: "EngagementId"
              KeyType: "HASH"
            - AttributeName: "ProvidedBy"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"
        - IndexName: !GetAtt DDBTenantEngagementTableEngagementIdIndex.Value
          KeySchema:
            - AttributeName: "EntityId"
              KeyType: "HASH"
            - AttributeName: "EngagementId"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"
        - IndexName: !GetAtt DDBTenantEngagementTableTimeStampIndex.Value
          KeySchema:
            - AttributeName: "EntityId"
              KeyType: "HASH"
            - AttributeName: "Timestamp"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"
      BillingMode: "PAY_PER_REQUEST"
      StreamSpecification:
        StreamViewType: NEW_IMAGE

  # - Tenant-Integration-Table -
  TenantIntegrationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub TenantIntegrationTable-${Environment}
      AttributeDefinitions:
        - AttributeName: TeamId
          AttributeType: S
      KeySchema:
        - AttributeName: TeamId
          KeyType: HASH
      BillingMode: "PAY_PER_REQUEST"

  # -- Tenant Teams table -
  # This table stores team information with user memberships
  # PK: TeamId (e.g., TEAM#uuid)
  # SK: METADATA or USER#username
  # GSI1: UserName-TeamId for querying all teams for a user
  TenantTeamsTableV2:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub TenantTeamsTableV2-${Environment}
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      BillingMode: "PAY_PER_REQUEST"
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: "GSI1PK"
              KeyType: "HASH"
            - AttributeName: "GSI1SK"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"

  # -- Team Attributes Table (V2) -
  # This table stores team-specific attributes (skills, values, milestones, metrics)
  # PK: AttributeId (e.g., ATTR-{uuid})
  # SK: TeamId (e.g., TEAM-{id})
  # GSI: TeamId-AttributeType-index for querying attributes by team and type
  DDBTeamAttributesTableTeamIdIndex:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/dynamodb/TeamAttributesTable-TeamIdIndex
      Type: String
      Value: TeamId-AttributeType-index

  TeamAttributesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub TeamAttributesTable-${Environment}
      AttributeDefinitions:
        - AttributeName: AttributeId
          AttributeType: S
        - AttributeName: TeamId
          AttributeType: S
        - AttributeName: AttributeType
          AttributeType: S
      KeySchema:
        - AttributeName: AttributeId
          KeyType: HASH
        - AttributeName: TeamId
          KeyType: RANGE
      BillingMode: "PAY_PER_REQUEST"
      GlobalSecondaryIndexes:
        - IndexName: !GetAtt DDBTeamAttributesTableTeamIdIndex.Value
          KeySchema:
            - AttributeName: "TeamId"
              KeyType: "HASH"
            - AttributeName: "AttributeType"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"

  # -- Organization related DDB Tables ---
  # This table stores organization information with user memberships
  # PK: OrganizationId (e.g., ORG#uuid)
  # SK: METADATA or USER#username
  # GSI1: UserName-OrganizationId for querying all organizations for a user
  OrgsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub OrgsTable-${Environment}
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: PlanType
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      BillingMode: "PAY_PER_REQUEST"
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: "GSI1PK"
              KeyType: "HASH"
            - AttributeName: "GSI1SK"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"
        - IndexName: PlanType-index
          KeySchema:
            - AttributeName: "PlanType"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"

  PromoCodesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub PromoCodesTable-${Environment}
      AttributeDefinitions:
        - AttributeName: PromoCode
          AttributeType: S
        - AttributeName: IsActive
          AttributeType: S
      KeySchema:
        - AttributeName: PromoCode
          KeyType: HASH
      BillingMode: "PAY_PER_REQUEST"
      GlobalSecondaryIndexes:
        - IndexName: IsActive-index
          KeySchema:
            - AttributeName: "IsActive"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"



  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # --------------- 5.Tenant user pool and client --------------------------------------------------------------------------------------------------
  # ------------------------------------------------------------------------------------------------------------------------------------------------

  TenantCognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub Tenant-UserPool-${Environment}
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false # change to true (not sure have to discuss)
        InviteMessageTemplate:
          EmailSubject: "Welcome to Gomovo Hub - Your Invitation"
          EmailMessage: |
            Hello,

            Welcome to Gomovo Hub! You have been invited to join our platform.

            Your username is: {username}
            Your temporary password is: {####}

            Please use this temporary password or one-time login code to sign in and set up your account.

            Sign in here: https://app.gomovo.com

            If you have any questions, please contact our support team.

            Best regards,
            The Gomovo Hub Team
          SMSMessage: "Welcome to Gomovo Hub! Your username is {username} and temporary password is {####}"
      DeletionProtection: INACTIVE # Change to Active for PROD Deployments
      UsernameAttributes:
        - email
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
      AutoVerifiedAttributes:
        - email
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: false
          Required: true
        - Name: given_name
          AttributeDataType: String
          Mutable: true
          Required: false
        - Name: family_name
          AttributeDataType: String
          Mutable: true
          Required: false
        - Name: name
          AttributeDataType: String
          Mutable: true
          Required: false
        - Name: userName
          AttributeDataType: String
          Mutable: true
          Required: false
        - Name: E_ID
          AttributeDataType: String
          Mutable: true
          Required: false
        - Name: phone_number
          AttributeDataType: String
          Mutable: true
          Required: false
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
      LambdaConfig:
        PostConfirmation: !GetAtt SyncCognitoUserToDynamoDBLambda.Arn
        PreAuthentication: !GetAtt SyncCognitoUserToDynamoDBLambda.Arn
        PreTokenGeneration: !GetAtt SyncCognitoUserToDynamoDBLambda.Arn
        PostAuthentication: !GetAtt SyncCognitoUserToDynamoDBLambda.Arn

  TenantProfileCognitoClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub TenantProfileClient-${Environment}
      UserPoolId: !Ref TenantCognitoUserPool
      AccessTokenValidity:
        !FindInMap [
          AccountMappings,
          !Ref "AWS::AccountId",
          TenantClientTokenValidityHRS,
        ]
      AuthSessionValidity:
        !FindInMap [
          AccountMappings,
          !Ref "AWS::AccountId",
          TenantClientAuthSessionValidityMin,
        ]
      GenerateSecret: false

  # ---------- Lambda to Sync Cognito Users to DynamoDB ----------

  SyncCognitoUserToDynamoDBLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub SyncCognitoUserToDynamoDB-${Environment}
      Runtime: python3.11
      Handler: sync_cognito_to_ddb.handler
      Timeout: 30
      CodeUri: ../../lambdas/tenant-lambdas/utils-functions/sync-cognito-to-ddb/
      Role: !GetAtt SyncCognitoUserToDynamoDBLambdaRole.Arn
      Tracing: Active
      Environment:
        Variables:
          EMPLOYEE_TABLE: !Ref EmployeeDataTable

  SyncCognitoUserToDynamoDBLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub SyncCognitoUserToDynamoDB-Role-${Environment}
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:GetItem
                Resource: !GetAtt EmployeeDataTable.Arn

  CognitoPostConfirmationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SyncCognitoUserToDynamoDBLambda
      Principal: cognito-idp.amazonaws.com
      Action: lambda:InvokeFunction
      SourceArn: !GetAtt TenantCognitoUserPool.Arn

  CognitoPreAuthenticationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SyncCognitoUserToDynamoDBLambda
      Principal: cognito-idp.amazonaws.com
      Action: lambda:InvokeFunction
      SourceArn: !GetAtt TenantCognitoUserPool.Arn

  CognitoPreTokenGenerationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SyncCognitoUserToDynamoDBLambda
      Principal: cognito-idp.amazonaws.com
      Action: lambda:InvokeFunction
      SourceArn: !GetAtt TenantCognitoUserPool.Arn

  CognitoPostAuthenticationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SyncCognitoUserToDynamoDBLambda
      Principal: cognito-idp.amazonaws.com
      Action: lambda:InvokeFunction
      SourceArn: !GetAtt TenantCognitoUserPool.Arn

  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # --------------- 6.Lambda Modules with business logic --------------------------------------------------------------------------------------------------
  # ------------------------------------------------------------------------------------------------------------------------------------------------

  # --------------- Employee Onboarding and Updating employee data --------------------------------------------------------------------------------------------------
  # ------------------------------------------------------------------------------------------------------------------------------------------------

  # ---------- Manage Employee Profile V2 Lambda ----------

  ManageEmployeeProfileV2Lambda:
    Type: AWS::Serverless::Function
    Properties:
      Architectures:
        - x86_64
      CodeUri: ../../lambdas/tenant-lambdas/employees-module/manage-employee-profile-v2/
      Description: "Simplified Employee Profile Management V2 - Get and Update basic profile"
      Role: !GetAtt ManageEmployeeProfileV2LambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Timeout: 300
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value
          COGNITO_USER_POOL_ID: !Ref TenantCognitoUserPool
          # CDN related variables
          SECRETS_CND_PK_ARN: !GetAtt PrivateKeySecretsCloudfront.Value
          PUBLIC_KEY_ID: !GetAtt CloudFrontPublicKeyId.Value
          CDN_DOMAIN: !GetAtt CDNforTenantsS3Store.DomainName
          # Contents Bucket Name
          BUCKET_NAME: !Ref TenantContentsBucket

  ManageEmployeeProfileV2LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaExecution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt EmployeeDataTable.Arn
                  - !Sub ${EmployeeDataTable.Arn}/index/*
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: 
                  - !GetAtt PrivateKeySecretsCloudfront.Value
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:cloudfront-private-key-${Environment}*"
              - Effect: Allow
                Action:
                  - cloudfront:*
                Resource: !Sub
                  - arn:aws:cloudfront::${AccountId}:distribution/${CdnId}
                  - CdnId: !Ref CDNforTenantsS3Store
                    AccountId: !Ref AWS::AccountId
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                Resource: !Sub
                  - arn:aws:s3:::${BucketName}/*
                  - BucketName: !Ref TenantContentsBucket
              - Effect: Allow
                Action:
                  - cognito-idp:AdminUpdateUserAttributes
                Resource: !GetAtt TenantCognitoUserPool.Arn

  ManageEmployeeProfileV2InvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ManageEmployeeProfileV2Lambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*


  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # --------------- Tenant Teams Related functions --------------------------------------------------------------------------------------------------
  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # ---------- Lambda to list user teams ----------

  ListUserTeamsLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to list all teams for a user and current team"
      Role: !GetAtt TeamsV2LambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/teams-module/list-user-teams/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          TEAMS_TABLE: !Ref TenantTeamsTableV2
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value

  ListUserTeamsLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ListUserTeamsLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Lambda to create team ----------

  CreateTeamLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to create a new team with creator as admin"
      Role: !GetAtt TeamsV2LambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/teams-module/create-team/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          TEAMS_TABLE: !Ref TenantTeamsTableV2
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value

  CreateTeamLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt CreateTeamLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Lambda to manage team operations ----------

  ManageTeamOperationsLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to manage team operations: deactivate, add users, assign admins"
      Role: !GetAtt TeamsV2LambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/teams-module/manage-team-operations/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          TEAMS_TABLE: !Ref TenantTeamsTableV2
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value
          COGNITO_USER_POOL_ID: !Ref TenantCognitoUserPool

  ManageTeamOperationsLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ManageTeamOperationsLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Lambda to set current team ----------

  SetCurrentTeamLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to set the user's current team"
      Role: !GetAtt TeamsV2LambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/teams-module/set-current-team/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          TEAMS_TABLE: !Ref TenantTeamsTableV2
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value

  SetCurrentTeamLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt SetCurrentTeamLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Lambda to manage team attributes (skills, values, milestones, metrics) ----------

  ManageTeamAttributesLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to manage team-specific attributes (skills, values, milestones, metrics) V2"
      Role: !GetAtt ManageTeamAttributesLambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/engagements-module/manage-team-attributes/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          TEAMS_TABLE: !Ref TenantTeamsTableV2
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value
          TEAM_ATTRIBUTES_TABLE: !Ref TeamAttributesTable
          TEAM_ATTRIBUTES_TEAMID_INDEX: !GetAtt DDBTeamAttributesTableTeamIdIndex.Value

  ManageTeamAttributesLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ManageTeamAttributesLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  ManageTeamAttributesLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ManageTeamAttributes-Lambda-Role-${Environment}
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Path: "/TeamAttributes/"
      Policies:
        - PolicyName: LambdaExecution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - cloudwatch:PutMetricData
                Resource: "*"
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                Resource: "*"
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt TeamAttributesTable.Arn
                  - !Sub ${TeamAttributesTable.Arn}/index/*
                  - !GetAtt TenantTeamsTableV2.Arn
                  - !Sub ${TenantTeamsTableV2.Arn}/index/*
                  - !GetAtt EmployeeDataTable.Arn
                  - !Sub ${EmployeeDataTable.Arn}/index/*

  # ---------- Shared IAM Role for Teams V2 Lambdas ----------

  TeamsV2LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub TeamsV2-Lambda-Role-${Environment}
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Path: "/TeamsV2/"
      Policies:
        - PolicyName: LambdaExecution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - cloudwatch:PutMetricData
                Resource: "*"
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                Resource: "*"
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt TenantTeamsTableV2.Arn
                  - !Sub ${TenantTeamsTableV2.Arn}/index/*
                  - !GetAtt EmployeeDataTable.Arn
                  - !Sub ${EmployeeDataTable.Arn}/index/*
              - Effect: Allow
                Action:
                  - dynamodb:TransactWriteItems
                Resource:
                  - !GetAtt TenantTeamsTableV2.Arn
                  - !GetAtt EmployeeDataTable.Arn 
              - Effect: Allow
                Action:
                  - ses:SendEmail
                  - ses:SendRawEmail
                Resource: "*"
              - Effect: Allow
                Action:
                  - cognito-idp:*
                Resource: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${TenantCognitoUserPool}  

  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # --------------- Organization Management Related functions --------------------------------------------------------------------------------------------------
  # ------------------------------------------------------------------------------------------------------------------------------------------------

  # ---------- Lambda to create organization ----------

  CreateOrganizationLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to create a new organization with admin user"
      Role: !GetAtt OrganizationLambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/org-module/create-organization/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          ORGANIZATION_TABLE: !Ref OrgsTable
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value
          PROMO_CODES_TABLE: !Ref PromoCodesTable

  CreateOrganizationLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt CreateOrganizationLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Lambda to manage organization ----------

  ManageOrganizationLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to get and update organization details"
      Role: !GetAtt OrganizationLambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/org-module/manage-organization/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          ORGANIZATION_TABLE: !Ref OrgsTable
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value

  ManageOrganizationLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ManageOrganizationLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Lambda to manage subscription ----------

  ManageSubscriptionLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to manage organization subscription plans and billing"
      Role: !GetAtt OrganizationLambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/org-module/manage-subscription/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          ORGANIZATION_TABLE: !Ref OrgsTable
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value

  ManageSubscriptionLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ManageSubscriptionLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Lambda to manage promo codes ----------

  ManagePromoCodesLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to apply and validate promotional codes"
      Role: !GetAtt OrganizationLambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/org-module/manage-promo-codes/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          ORGANIZATION_TABLE: !Ref OrgsTable
          PROMO_CODES_TABLE: !Ref PromoCodesTable
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value

  ManagePromoCodesLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ManagePromoCodesLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Lambda to list user organizations ----------

  ListUserOrganizationsLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Lambda to list all organizations where user is admin"
      Role: !GetAtt OrganizationLambdaRole.Arn
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      CodeUri: ../../lambdas/tenant-lambdas/org-module/list-user-organizations/
      Tracing: Active
      Environment:
        Variables:
          Environment: !Ref Environment
          ORGANIZATION_TABLE: !Ref OrgsTable
          EMPLOYEE_TABLE: !Ref EmployeeDataTable
          EMPLOYEE_TABLE_COGNITO_ID_INDEX: !GetAtt DDBEmployeeDataTableCognitoIdIndex.Value

  ListUserOrganizationsLambdaInvokePermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ListUserOrganizationsLambda.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${TenantAPIGateway}/*

  # ---------- Shared IAM Role for Organization Lambdas ----------

  OrganizationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub Organization-Lambda-Role-${Environment}
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Path: "/Organization/"
      Policies:
        - PolicyName: LambdaExecution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - cloudwatch:PutMetricData
                Resource: "*"
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                Resource: "*"
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:TransactGetItems
                  - dynamodb:TransactWriteItems
                  - dynamodb:DeleteItem
                Resource:
                  - !GetAtt OrgsTable.Arn
                  - !Sub ${OrgsTable.Arn}/index/*
                  - !GetAtt PromoCodesTable.Arn
                  - !Sub ${PromoCodesTable.Arn}/index/*
                  - !GetAtt EmployeeDataTable.Arn
                  - !Sub ${EmployeeDataTable.Arn}/index/*
              - Effect: Allow
                Action:
                  - dynamodb:TransactWriteItems
                Resource:
                  - !GetAtt OrgsTable.Arn
                  - !GetAtt PromoCodesTable.Arn
                  - !GetAtt EmployeeDataTable.Arn 
              - Effect: Allow
                Action:
                  - ses:SendEmail
                  - ses:SendRawEmail
                Resource: "*"

  # ------------------------------------------------------------------------------------------------------------------------------------------------
  # ---------- 7.Cloudfront for all the content delivery in Tenant Portal ----------

  # --------- S3 bucket to store for content storage

  TenantContentsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub tenant-contents-${AWS::AccountId}-${Environment}

  S3CDNBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref TenantContentsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Id: "PolicyForCloudFrontPrivateContent"
        Statement:
          - Sid: "AllowCloudFrontServicePrincipal"
            Effect: "Allow"
            Principal:
              Service: "cloudfront.amazonaws.com"
            Action: "s3:GetObject"
            Resource: !Sub "arn:aws:s3:::tenant-contents-${AWS::AccountId}-${Environment}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub
                  - arn:aws:cloudfront::${AWS::AccountId}:distribution/${CdnId}
                  - CdnId: !Ref CDNforTenantsS3Store
                    AccountId: !Ref AWS::AccountId

  CardsS3OriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: "Identity for accessing Cards S3 bucket"

  # Reference to private key secret - use provided ARN if available, otherwise create new secret
  PrivateKeySecretsCloudfront:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${AWS::StackName}/cloudfront/private-key-secret-arn
      Type: String
      Value: !If
        - UseProvidedCloudFrontKeys
        - !Ref CloudFrontPrivateKeySecretArn
        - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/cloudfront/keys/private-key-images-${Environment}

  TenantKeyGroup:
    Type: AWS::CloudFront::KeyGroup
    Properties:
      KeyGroupConfig:
        Comment: "This is the key group for signed URLs"
        Items:
          - !GetAtt CloudFrontPublicKeyId.Value # Id for the required publickey. This is created outside of the Cloudformation.
        Name: !Sub TenantKeyGroup-${Environment}

  OriginAccessControlTenants:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Description: OAC for the CDN
        Name: !Sub OAC-CDN-TENANTS-${Environment}
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CDNforTenantsS3Store:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Origins:
          - Id: TenantContentS3Origin
            DomainName: !GetAtt TenantContentsBucket.DomainName
            OriginAccessControlId: !GetAtt OriginAccessControlTenants.Id
            S3OriginConfig:
              OriginAccessIdentity: "" # Empty OAI as we are using OAC , Ref: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudfront-distribution-s3originconfig.html
        CacheBehaviors:
          - CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6 # Ref: https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-managed-cache-policies.html#managed-cache-caching-optimized
            PathPattern: "*"
            TargetOriginId: TenantContentS3Origin
            ViewerProtocolPolicy: redirect-to-https
            TrustedKeyGroups:
              - !Ref TenantKeyGroup
        DefaultCacheBehavior:
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6 # Ref: https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-managed-cache-policies.html#managed-cache-caching-optimized
          TargetOriginId: TenantContentS3Origin
          ViewerProtocolPolicy: redirect-to-https

  # ----------- Custom resource to onboard data into DDB Table-----------
  # ----------- This is a one time operation to load the default data into the DDB Table ------------
  ManageDDBTableDefaultData:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Loads and Deletes Default data"
      CodeUri: ../../cfn_handler_resources/load-default-data/
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
        - x86_64
      Timeout: 300
      Tracing: Active
      Policies:
        - AWSLambdaExecute
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
              Resource: "*"

  # ---------- Automated Testing stack role ----------

  AutoTestExecutionRole:
    Type: AWS::IAM::Role
    Condition: IsTestBuild
    Properties:
      Path: /testing/
      RoleName: !Sub saas-tenant-apis-${Environment}-auto-test-role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaExecution
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - dynamodb:*
                Resource: "*"
              - Effect: Allow
                Action:
                  - lambda:*
                Resource: "*"
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
              - Effect: Allow
                Action:
                  - apigateway:*
                Resource: "*"

Outputs:
  TenantProfilePoolId:
    Description: "Tenant User Pool ID"
    Value:
      Ref: TenantCognitoUserPool
  TenantProfilePoolClientId:
    Description: "Tenant User Pool Client ID"
    Value:
      Ref: TenantProfileCognitoClient
